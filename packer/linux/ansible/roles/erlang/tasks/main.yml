---
- name: Download GPG key
  get_url:
    url: https://github.com/rabbitmq/signing-keys/releases/download/3.0/cloudsmith.rabbitmq-erlang.E495BB49CC4BBE5B.key
    dest: /usr/share/keyrings/rabbitmq.E495BB49CC4BBE5B.gpg_armored
    checksum: sha256:84df2e5fd80d464c3eb9acd2f751b2f6a723438200915dd50fbf12f08698e4ec

- name: De-Armor GPG key
  command: gpg --dearmor < /usr/share/keyrings/rabbitmq.E495BB49CC4BBE5B.gpg_armored > /usr/share/keyrings/rabbitmq.E495BB49CC4BBE5B.gpg
  no_log: true
  args:
    creates: /usr/share/keyrings/rabbitmq.E495BB49CC4BBE5B.gpg

- name: "Add repository to APT sources list"
  ansible.builtin.apt_repository:
  repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/rabbitmq.E495BB49CC4BBE5B.gpg] https://ppa1.rabbitmq.com/rabbitmq/rabbitmq-erlang/deb/ubuntu focal main"
  state: present

- name: "Add src repository to APT sources list"
  ansible.builtin.apt_repository:
  repo: "deb-src [signed-by=/usr/share/keyrings/rabbitmq.E495BB49CC4BBE5B.gpg] https://ppa1.rabbitmq.com/rabbitmq/rabbitmq-erlang/deb/ubuntu focal main"
  state: present

- name: Install Erlang
  when: install_erlang | bool
  ansible.builtin.apt:
    pkg:
      - erlang-base=1:24.3.4.17-1
