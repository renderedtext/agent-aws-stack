version: v1.0
name: Detroy Agent Stacks
agent:
  machine:
    type: e2-standard-2
    os_image: ubuntu2204

# We still don't have a way to programatically create agent types, so we need to share the same agent type.
# To avoid running into issues where different pipelines might be doing something different things to the
# same stack at the same time, we use a queue.
queue:
  name: Testing
  scope: project

blocks:
  - name: Destroy Stacks
    task:
      secrets:
        - name: agent-aws-stack-tester-credentials
      jobs:
        - name: Destroy Linux stack
          commands:
            - checkout
            - cache restore
            - SEMAPHORE_AGENT_STACK_CONFIG=./ci/linux-config.json npm run destroy:ci
        - name: Destroy Windows stack
          commands:
            - checkout
            - cache restore
            - SEMAPHORE_AGENT_STACK_CONFIG=./ci/windows-config.json npm run destroy:ci
